{% extends "components/base.html" %}

{% block title %}Fechas Bloqueadas{% endblock %}

{% block outbody %}


{% comment %}
MODAL PARA BLOQUEAR UN MES COMPLETO
{% endcomment %}
<dialog id="modal-mes-bloquear" tabindex="-1" closedby="any">
    <div class="modal-content">
        <div class="card rounded rounded-3 overflow-hidden">
            <form class="card-header d-flex justify-content-between align-items-center text-white"
                style="background-color: #784eb3;">
                <h3 class="text-center my-3">Bloquear mes</h3>
                <button class="btn-close btn-lg btn-close-white" formmethod="dialog"></button>
            </form>
            <div class="card-body">
                <form action="" method="post" novalidate>
                    {% csrf_token %}
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                        <div class="form-floating">
                            {{ form_meses.fecha_inferior }}
                            <label for="id_fecha">{{ form_meses.fecha_inferior.label }}</label>
                        </div>
                        <div class="form-floating">
                            {{ form_meses.fecha_superior }}
                            <label for="id_fecha">{{ form_meses.fecha_superior.label }}</label>
                        </div>
                    </div>

                    <div class="form-control mb-3 pb-3">
                        <label class="form-check-label fs-6 fw-semibold" for="{{ form.motivo.id_for_label }}">
                            {{ form_meses.motivo.label }}
                        </label>
                        {{ form_meses.motivo }}
                    </div>

                    <div class="mb-3 text-end">
                        <input type="submit" value="Cancelar" class="btn btn-secondary" formmethod="dialog">
                        <input type="submit" value="Guardar" class="btn text-white" style="background-color: #784eb3;">
                    </div>
                </form>
            </div>
        </div>
    </div>
</dialog>


{% comment %}
MODAL PARA EDITAR O CREAR UNA FECHA BLOQUEADA
{% endcomment %}
<dialog id="modal-bloquear" tabindex="-1" closedby="any">
    <div class="modal-content">
        <div class="card rounded rounded-3 overflow-hidden">
            <form class="card-header d-flex justify-content-between align-items-center text-white"
                style="background-color: #784eb3;">
                <h3 class="text-center my-3">Bloquear fecha</h3>
                <button class="btn-close btn-lg btn-close-white" formmethod="dialog"></button>
            </form>
            <div class="card-body">
                <form action="" method="post" novalidate>
                    {% csrf_token %}
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                        <div class="form-floating">
                            {{ form.fecha }}
                            <label for="id_fecha">{{ form.fecha.label }}</label>
                        </div>
                    </div>
                    {% if messages %}
                    {% for message in messages %}
                    <div class="toast align-items-center text-bg-danger border-0 w-100 my-2" role="alert"
                        aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
                        <div class="d-flex">
                            <div class="toast-body">
                                <small>{{ message }}</small>
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                                aria-label="Close" tabindex="-1"></button>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <div class="form-control mb-3">
                        <div class="form-check form-switch fs-4">
                            {{ form.todo_el_dia }}
                            <label class="form-check-label fs-6" for="{{ form.todo_el_dia.id_for_label }}">
                                {{ form.todo_el_dia.label }}
                            </label>
                        </div>

                        {% for checkbox in form.horarios %}
                        <div class="form-check form-switch fs-4">
                            {{ checkbox.tag }}
                            <label class="form-check-label fs-6" for="{{ checkbox.id_for_label }}">
                                {{ checkbox.choice_label }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="form-control mb-3 pb-3">
                        <label class="form-check-label fs-6 fw-semibold" for="{{ form.motivo.id_for_label }}">
                            {{ form.motivo.label }}
                        </label>
                        {{ form.motivo }}
                    </div>

                    <div class="mb-3 text-end">
                        <input type="submit" value="Cancelar" class="btn btn-secondary" formmethod="dialog">
                        <input type="submit" value="Guardar" class="btn text-white" style="background-color: #784eb3;">
                    </div>
                </form>
            </div>
        </div>
    </div>
</dialog>

{% comment %}
MODAL PARA ELIMINAR UNA FECHA BLOQUEADA
{% endcomment %}
<dialog id="modal-eliminar" tabindex="-1" closedby="any" style="width: 22rem;">
    <div class="card rounded rounded-3 overflow-hidden px-3">
        <form class="modal-header d-flex justify-content-between align-items-center">
            <h3 class="text-center my-3">Desbloquear fecha</h3>
            <button class="btn-close btn-lg" formmethod="dialog"></button>
        </form>
        <form action="{% url 'testeando_eliminar' %}" method="post">
            {% csrf_token %}
            <div class="modal-body">
                <p class="text-center">¿Deseas desbloquear esta fecha?</p>
                <p class="text-center" id="modal-fecha"></p>
                <input type="hidden" name="fecha" id="fecha-eliminar">
            </div>
            <div class="modal-footer mb-3">
                <div class="text-end">
                    <input type="submit" value="Cancelar" class="btn btn-secondary" formmethod="dialog">
                    <input type="submit" value="Confirmar" class="btn btn-danger">
                </div>
            </div>
        </form>
    </div>
</dialog>
{% endblock %}

<br>
<br>
{% block body %}
<div class="min-h-screen pt-24 pb-12 px-3 bg-gradient-to-r from-pink-400 via-purple-500 to-blue-500">
    <div class="flex justify-center">
        <div class="w-full max-w-4xl">
            <div class="bg-white/70 backdrop-blur-md shadow-xl rounded-2xl overflow-hidden">
                <div class="bg-gray-900 text-white px-6 py-4 rounded-t-2xl">
                    <h4 class="text-2xl text-center font-bold text-pink-800">Fechas bloqueadas</h4>
                </div>
                <div class="p-6 bg-white/70 rounded-b-2xl">
                    <!-- el resto de tu lógica sin cambios -->


                    <!-- Filtros -->
                   <div class="flex flex-col lg:flex-row justify-between items-center gap-6 mb-6">
    <div class="flex flex-wrap items-center gap-3 bg-white/60 backdrop-blur-sm px-4 py-3 rounded-xl shadow-sm">
        <label for="selector-mes" class="text-sm font-semibold text-pink-800">Filtrar:</label>


                            <select id="selector-mes" class="border border-gray-300 rounded-md px-3 py-1 text-sm min-w-[130px]">
                                {% for mes in meses_disponibles %}
                                <option value="{{ mes.1 }}" {% if mes.1 == hoy.month %}selected{% endif %}>
                                    {{ mes.0 }}
                                </option>
                                {% endfor %}
                            </select>

                            <select id="selector-año" class="border border-gray-300 rounded-md px-3 py-1 text-sm min-w-[100px]">
                                {% for año in años_disponibles %}
                                <option value="{{ año }}" {% if año == hoy.year %}selected{% endif %}>
                                    {{ año }}
                                </option>
                                {% endfor %}
                            </select>

                            <button id="btn-buscar-fechas"
                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-3 py-1.5 rounded-md flex items-center gap-2 transition">
                                <i class="bi bi-search"></i>
                                Buscar
                            </button>
                        </div>

                        <div class="flex gap-3">
                            <button id="btn-nueva-fecha"
                                class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium px-3 py-1.5 rounded-md flex items-center gap-2 transition">
                                <i class="bi bi-plus-circle-fill"></i>
                                Nueva fecha
                            </button>
                            <button id="btn-nuevo-mes"
                                class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium px-3 py-1.5 rounded-md flex items-center gap-2 transition">
                                <i class="bi bi-plus-circle-fill"></i>
                                Bloquear mes
                            </button>
                        </div>
                    </div>

                    <!-- Lista de fechas -->
                    <div class="divide-y divide-gray-200">
                        {% for fecha in fechas_bloqueadas %}
                        <div class="flex justify-between items-start flex-wrap py-4">
                            <!-- Información de la fecha -->
                            <div class="flex flex-col gap-1">
                                <div class="font-semibold text-lg">📆 {{ fecha.fecha }}</div>

                                <div class="flex flex-wrap gap-2">
                                    {% if fecha.horas_bloqueadas.count == 4 or fecha.horas_bloqueadas.count == 0 %}
                                    <span class="bg-red-600 text-white text-xs px-2 py-1 rounded">🕗 Día completo</span>
                                    {% else %}
                                        {% for hora in fecha.horas_bloqueadas.all %}
                                        <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">🕗 {{ hora.hora|time:"H:i" }}</span>
                                        {% empty %}
                                        <span class="bg-gray-500 text-white text-xs px-2 py-1 rounded">🕗 Sin horario</span>
                                        {% endfor %}
                                    {% endif %}
                                </div>

                                <div class="text-gray-500 text-sm">{{ fecha.motivo|default:"—" }}</div>
                            </div>

                            <!-- Botones -->
                            <div class="flex gap-2 mt-3 lg:mt-0">
                                <button type="button" id="eliminar-{{fecha.id}}"
                                    class="border border-red-600 text-red-600 hover:bg-red-600 hover:text-white p-2 rounded-lg transition"
                                    data-alt="{{ fecha.fecha }}" data-fecha='{{fecha.fecha|date:"Y-m-d" }}'>
                                    <i class="bi bi-trash3-fill"></i>
                                </button>
                                <button type="button" id="fecha-{{fecha.id}}"
                                    class="border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white p-2 rounded-lg transition"
                                    data-id="{{fecha.id}}" data-fecha='{{fecha.fecha|date:"Y-m-d" }}'
                                    data-horarios='{{fecha.json | safe}}' data-motivo="{{fecha.motivo}}">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-gray-500 py-4">
                            No hay fechas bloqueadas registradas.
                        </div>
                        {% endfor %}
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>



<script>
    
    const buscador = document.getElementById('btn-buscar-fechas')
    buscador.addEventListener('click', evt => {
        const mes = document.getElementById('selector-mes').value
        const año = document.getElementById('selector-año').value
        const url = `${window.location.pathname}?mes=${mes}&año=${año}`
        window.location.href = url
    })
    

    const modalEliminar = document.getElementById('modal-eliminar')
    const inputEliminar = document.getElementById('fecha-eliminar')
    const pFecha = document.getElementById('modal-fecha')
    const botonesEliminar = document.querySelectorAll('button[id^="eliminar-"]');
    botonesEliminar.forEach(boton => {
        boton.addEventListener('click', evt => {
            if (modalEliminar && inputEliminar) {
                inputEliminar.value = boton.dataset.fecha
                pFecha.innerHTML = boton.dataset.alt
                modalEliminar.showModal()
            }
        })
    })



    const modalMes = document.getElementById('modal-mes-bloquear')
    const botonBloquearMes = document.getElementById('btn-nuevo-mes')
    if (modalMes && botonBloquearMes) {
        botonBloquearMes.addEventListener('click', evt => {
            modalMes.showModal()
        })
    }


    const modal = document.getElementById('modal-bloquear')
    const boton = document.getElementById('btn-nueva-fecha')
    if (boton && modal) {
        boton.addEventListener('click', evt => {
            inputFecha.value = ''
            inputMotivo.value = ''
            modal.showModal()
        })
    }

    const inputFecha = document.getElementById('id_fecha')
    const inputFull = document.getElementById('id_todo_el_dia')
    const inputHor0 = document.getElementById('id_horarios_0')
    const inputHor1 = document.getElementById('id_horarios_1')
    const inputHor2 = document.getElementById('id_horarios_2')
    const inputHor3 = document.getElementById('id_horarios_3')
    const inputMotivo = document.getElementById('id_motivo')

    const botones = document.querySelectorAll('button[id^="fecha-"]');
    botones.forEach(boton => {
        boton.addEventListener('click', evt => {
            if (modal) {
                if (boton.dataset.horarios && boton.dataset.horarios !== "") {
                    const horarios = JSON.parse(boton.dataset.horarios);
                    if (
                        horarios.includes('09:00:00') &&
                        horarios.includes('12:00:00') &&
                        horarios.includes('16:00:00') &&
                        horarios.includes('19:00:00')
                    ) {
                        inputFull.checked = true;

                        inputHor0.checked = true;
                        inputHor1.checked = true;
                        inputHor2.checked = true;
                        inputHor3.checked = true;

                        inputHor0.disabled = true;
                        inputHor1.disabled = true;
                        inputHor2.disabled = true;
                        inputHor3.disabled = true;
                    }
                    else {
                        inputFull.checked = false;
                        inputHor0.checked = horarios.includes('09:00:00')
                        inputHor1.checked = horarios.includes('12:00:00')
                        inputHor2.checked = horarios.includes('16:00:00')
                        inputHor3.checked = horarios.includes('19:00:00')
                        inputHor0.disabled = false;
                        inputHor1.disabled = false;
                        inputHor2.disabled = false;
                        inputHor3.disabled = false;
                    }
                } else {
                    inputFull.checked = false;
                    inputHor0.checked = false;
                    inputHor1.checked = false;
                    inputHor2.checked = false;
                    inputHor3.checked = false;

                    inputHor0.disabled = false;
                    inputHor1.disabled = false;
                    inputHor2.disabled = false;
                    inputHor3.disabled = false;
                }
                inputFecha.value = boton.dataset.fecha
                inputMotivo.value = boton.dataset.motivo
                modal.showModal()
            }
        })
    })

    const todosHorarios = document.getElementById('{{ form.todo_el_dia.id_for_label }}')
    const checkboxes = document.querySelectorAll('input[id^="id_horarios_"]');
    if (todosHorarios) {
        todosHorarios.addEventListener('input', evt => {
            console.log(evt.target.checked)
            checkboxes.forEach(checkbox => {
                checkbox.disabled = evt.target.checked
            });
        })
    }
</script>
{% endblock %}